<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>창고검색</title>
    <meta content="" name="description">
    <meta content="" name="keywords">
    <link href="/assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
            href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,600;1,700&family=Roboto:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Work+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
            rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="/assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="/assets/vendor/aos/aos.css" rel="stylesheet">
    <link href="/assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
    <link href="/assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <link href="/assets/css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        #search-container {
            position: absolute;
            top: 140px;
            left: 20px;
            z-index: 9999;
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        #show-traffic {
            position: absolute;
            top: 200px;
            left: 20px;
            z-index: 9999;
            background-color: #333;
            padding: 0px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }


        .wrap {
            position: absolute;
            left: 0;
            bottom: 40px;
            width: 288px;
            height: 132px;
            margin-left: -144px;
            text-align: left;
            overflow: hidden;
            font-size: 12px;
            font-family: 'Malgun Gothic', dotum, '돋움', sans-serif;
            line-height: 1.5;
        }

        .wrap * {
            padding: 0;
            margin: 0;
        }

        .wrap .info {
            width: 286px;
            height: 120px;
            border-radius: 5px;
            border-bottom: 2px solid #ccc;
            border-right: 1px solid #ccc;
            overflow: hidden;
            background: #fff;
        }

        .wrap .info:nth-child(1) {
            border: 0;
            box-shadow: 0px 1px 2px #888;
        }

        .info .title {
            padding: 5px 0 0 10px;
            height: 30px;
            background: #eee;
            border-bottom: 1px solid #ddd;
            font-size: 18px;
            font-weight: bold;
        }

        .info .close {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #888;
            width: 17px;
            height: 17px;
            background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/overlay_close.png');
        }

        .info .close:hover {
            cursor: pointer;
        }

        .info .body {
            position: relative;
            overflow: hidden;
        }

        .info .desc {
            position: relative;
            margin: 13px 0 0 90px;
            height: 75px;
        }

        .desc .ellipsis {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .desc .jibun {
            font-size: 11px;
            color: #888;
            margin-top: -2px;
        }

        .info .img {
            position: absolute;
            top: 6px;
            left: 5px;
            width: 73px;
            height: 71px;
            border: 1px solid #ddd;
            color: #888;
            overflow: hidden;
        }

        .info:after {
            content: '';
            position: absolute;
            margin-left: -12px;
            left: 50%;
            bottom: 0;
            width: 22px;
            height: 12px;
            background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/vertex_white.png')
        }

        .info .link {
            color: #5085BB;
        }
    </style>
</head>
<body>
<div th:if="${session.userSession != null}">
    <div th:replace="~{fragments/header_user :: header}"></div>

    <section id="hero" class="hero">
        <div class="carousel-item active" style="background-image: url(/assets/img/hero-carousel/hero-carousel-1.jpg)">
        </div>
    </section>
    <div id="search-container">
        <div id="search-input-container">
            <input type="text" id="addressInput" placeholder="주소를 입력하세요">
            <button id="searchButton" onclick="searchAddress()">
                <i class="fas fa-search"></i> <!-- 돋보기 아이콘 추가 -->
            </button>
        </div>
    </div>
    <div id="show-traffic">
        <button id="showTrafficButton" onclick="toggleTraffic()">교통 상황</button>
    </div>

    <div id="map" style="width:100%;height:90vh;margin-top: 100px"></div>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f8bbc7549216335625367284bd469f94&libraries=clusterer,services"></script>
    <script>
        var mapContainer = document.getElementById('map');
        var mapOption = {
            center: new kakao.maps.LatLng(37.56692, 126.97845),
            level: 3,
            mapTypeId: kakao.maps.MapTypeId.ROADMAP
        };

        var currentOverlay = null;

        function closeOverlay() {
            if (currentOverlay) {
                currentOverlay.setMap(null);
            }
        }

        function attachOverlay(marker, content) {
            kakao.maps.event.addListener(marker, 'click', function () {
                closeOverlay();

                var overlay = new kakao.maps.CustomOverlay({
                    content: content,
                    map: map,
                    position: marker.getPosition()
                });

                currentOverlay = overlay;
            });
        }

        function searchAddress() {
            var addressInput = document.getElementById('addressInput');
            var address = addressInput.value;

            if (address) {
                var geocoder = new kakao.maps.services.Geocoder();

                geocoder.addressSearch(address, function (result, status) {
                    if (status === kakao.maps.services.Status.OK && result.length > 0) {
                        map.setCenter(new kakao.maps.LatLng(result[0].y, result[0].x));
                    } else {
                        alert('주소를 찾을 수 없습니다.');
                    }
                });
            } else {
                alert('주소를 입력하세요.');
            }
        }

        var map = new kakao.maps.Map(mapContainer, mapOption);


        var imageSrc = '/assets/img/team/storage.png',
            imageSize = new kakao.maps.Size(40, 45),
            imageOption = {offset: new kakao.maps.Point(27, 69)};

        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption),
            markerPosition = new kakao.maps.LatLng(37.54699, 127.09598);

        var mapTypeControl = new kakao.maps.MapTypeControl();


        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);


        var zoomControl = new kakao.maps.ZoomControl();

        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
        map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);


        var clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            averageCenter: true,
            minLevel: 5
        });

        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/conta", true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var data = JSON.parse(xhr.responseText).datas;

                var markers = [];

                for (var i = 0; i < data.length; i++) {
                    var marker = new kakao.maps.Marker({
                        position: new kakao.maps.LatLng(data[i].we, data[i].kyung), //좌표,좌표
                        map: map,
                        image: markerImage
                    });

                    markers.push(marker);

                    var content = '<div class="wrap">' +
                        '    <div class="info">' +
                        '        <div class="title">' +
                        '            창고 정보' +
                        '            <div class="close" onclick="closeOverlay()" title="닫기"></div>' +
                        '        </div>' +
                        '        <div class="body">' +
                        '            <div class="img">' +
                        '                <img src="/static/upload/' + data[i].con_image_url + '" width="73" height="70">' +
                        '           </div>' +
                        '            <div class="desc">' +
                        '                <div style="display:none" class="ellipsis">창고번호: ' + data[i].con_no + '</div>' +
                        '                <div class="ellipsis">회사명: ' + data[i].con_name + '</div>' +
                        '                <div class="ellipsis">주소: ' + data[i].con_addr + '</div>' +
                        '                <div class="ellipsis">크기: ' + data[i].con_area + ' </div>' +
                        '            <div><a href="javascript:void(0);" onclick="openPopup(' + data[i].con_no + ')">창고 예약하기</a></div>' +
                        '            </div>' +
                        '    </div>' +
                        '</div>';


                    attachOverlay(marker, content);
                }


                clusterer.addMarkers(markers);
            }
        };
        xhr.send();


        function closeOverlay() {
            if (currentOverlay) {
                currentOverlay.setMap(null);
            }
        }


        var currentOverlay = null;

        function attachOverlay(marker, content) {
            kakao.maps.event.addListener(marker, 'click', function () {
                // 기존 오버레이가 있으면 닫기
                closeOverlay();

                var overlay = new kakao.maps.CustomOverlay({
                    content: content,
                    map: map,
                    position: marker.getPosition()
                });


                currentOverlay = overlay;

                var popupButton = overlay.getElement().querySelector('.popup-button');
                if (popupButton) {
                    popupButton.addEventListener('click', function () {
                        openPopup();
                    });
                }
            });
        }

        function openPopup(conNo) {
            var encodedConNo = encodeURIComponent(conNo);
            var url = 'booking/booking?con_no=' + encodedConNo;

            window.open(url, '_blank', 'width=1000, height=800');
        }

        var trafficShown = false;
        map.removeOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);

        function toggleTraffic() {
            if (trafficShown) {
                map.removeOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);
                trafficShown = false;
            } else {
                map.addOverlayMapTypeId(kakao.maps.MapTypeId.TRAFFIC);
                trafficShown = true;
            }
        }
    </script>
</div>
</body>
</html>