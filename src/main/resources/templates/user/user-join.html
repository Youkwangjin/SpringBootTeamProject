<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>에이콘테이너 : 회원가입</title>
    <link rel="stylesheet" href="/css/user/user-join.css">
    <link rel="icon" type="image/png" href="/assets/img/favicon.png">
    <link href="/assets/css/main.css" rel="stylesheet">
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="/js/user/user-join.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let userEmail = document.getElementById('userEmail');
            let userPassword = document.getElementById('userPassword');
            let userRePassword = document.getElementById('userRePassword');
            let userName = document.getElementById('userName');
            let userTel = document.getElementById('userTel');
            let userAddr = document.getElementById('userAddress');

            let emailResult = document.querySelector(".email-result");
            let passwordResult = document.querySelector(".password-result");
            let rePasswordResult = document.querySelector(".rePassword-result");
            let nameResult = document.querySelector(".name-result");
            let telResult = document.querySelector(".tel-result");
            let resetButton = document.getElementById('btnReset');
            let submitButton = document.getElementById('btnUserJoin');

            let validStates = {
                userEmail: false,
                userPassword: false,
                userRePassword: false,
                userName: false,
                userTel: false
            };

            function checkFormValid() {
                const allValid = Object.values(validStates).every(Boolean);
                submitButton.disabled = !allValid;
            }

            userEmail.addEventListener("change", (e) => {
                validEmail(e.target, emailResult);
            });

            userPassword.addEventListener("input", (e) => {
                validPassword(e.target, passwordResult);
            });

            userRePassword.addEventListener("change", (e) => {
                validRePassword(e.target, userPassword.value, rePasswordResult);
            });

            userName.addEventListener("input", (e) => {
                validName(e.target, nameResult);
            });

            userTel.addEventListener("input", (e) => {
                validTel(e.target, telResult);
            });

            resetButton.addEventListener('click', function () {
                window.location.href = '/user/login';
            });

            document.getElementById('userEmail').addEventListener('blur', function() {
                validEmail(this, document.querySelector('.email-result'));
            });

            // 이메일 형식 체크 정규식
            function validEmail(emailInput, resultElement) {
                const email = emailInput.value.trim();
                if (email.length === 0) {
                    resultElement.textContent = '이메일을 입력해주세요.';
                    resultElement.classList.remove('success');
                    resultElement.classList.add('error');
                    emailInput.focus();
                    validStates.userEmail = false;
                } else if (!validEmailCheck(email)) {
                    resultElement.textContent = '이메일 형식으로 입력해주세요.';
                    resultElement.classList.remove('success');
                    resultElement.classList.add('error');
                    emailInput.focus();
                    validStates.userEmail = false;
                } else {
                    // 이메일 형식이 유효한 경우, 서버에 중복 검사 요청
                    checkEmailDuplication(emailInput, resultElement);
                }
                checkFormValid();
            }

            // 서버에 이메일 중복 검사 요청
            function checkEmailDuplication(emailInput, resultElement) {
                const userEmail = emailInput.value.trim();
                fetch('/user/emailCheck?userEmail=' + encodeURIComponent(userEmail), {
                    method: 'GET',
                    credentials: 'include',
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('네트워크 응답이 정상이 아닙니다.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.isDuplicate) {
                            resultElement.textContent = '이미 사용 중인 이메일입니다.';
                            resultElement.classList.add('error');
                            resultElement.classList.remove('success');
                            validStates.userEmail = false;
                        } else {
                            resultElement.textContent = '사용 가능한 이메일입니다.';
                            resultElement.classList.add('success');
                            resultElement.classList.remove('error');
                            validStates.userEmail = true;
                        }
                        checkFormValid();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        resultElement.textContent = '서버 에러로 중복 체크를 할 수 없습니다.';
                        resultElement.classList.add('error');
                        resultElement.classList.remove('success');
                        validStates.userEmail = false;
                        checkFormValid();
                    });
            }

            function validEmailCheck(email) {
                let emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
                return emailPattern.test(email);
            }

            // 비밀번호 형식 체크 정규식
            function validPassword(passwordInput, resultElement) {
                const password = passwordInput.value.trim();
                if (password.length === 0) {
                    resultElement.textContent = '비밀번호를 입력해주세요.';
                    resultElement.classList.remove('success');
                    resultElement.classList.add('error');
                    passwordInput.focus();
                    validStates.userPassword = false;
                } else if (!validPasswordCheck(password)) {
                    resultElement.textContent = '비밀번호는 10자 이상이며, 특수문자를 포함해야 합니다.';
                    resultElement.classList.remove('success');
                    resultElement.classList.add('error');
                    passwordInput.focus();
                    validStates.userPassword = false;
                } else {
                    resultElement.textContent = '사용 가능한 비밀번호입니다.';
                    resultElement.classList.remove('error');
                    resultElement.classList.add('success');
                    validStates.userPassword = true;
                }
                checkFormValid();
            }

            function validPasswordCheck(password) {
                let passwordPattern = /^(?=.*[!@#$%^&*()_+{}":;'<>?,./]).{10,}$/;
                return passwordPattern.test(password);
            }

            // 비밀번호 재확인
            function validRePassword(rePasswordInput, originalPassword, resultElement) {
                if (rePasswordInput.value !== originalPassword) {
                    resultElement.textContent = '비밀번호가 일치하지 않습니다.';
                    resultElement.classList.remove('success');
                    resultElement.classList.add('error');
                    rePasswordInput.focus();
                    validStates.userRePassword = false;
                } else if (rePasswordInput.value === '') {
                    resultElement.textContent = '';
                    resultElement.classList.remove('success', 'error');
                } else {
                    resultElement.textContent = '비밀번호가 일치합니다.';
                    resultElement.classList.remove('error');
                    resultElement.classList.add('success');
                    validStates.userRePassword = true;
                }
                checkFormValid();
            }

            // 이름 형식 정규식 체크
            function validName(nameInput, resultElement) {
                const name = nameInput.value.trim();
                if (name.length === 0) {
                    resultElement.textContent = '이름을 입력해주세요.';
                    resultElement.classList.remove('success');
                    resultElement.classList.add('error');
                    nameInput.focus();
                    validStates.userName = false;
                } else if (!validNameCheck(name)) {
                    resultElement.textContent = '이름을 올바르게 입력해주세요.';
                    resultElement.classList.remove('success');
                    resultElement.classList.add('error');
                    nameInput.focus();
                    validStates.userName = false;
                } else {
                    resultElement.textContent = '사용 가능한 이름입니다.';
                    resultElement.classList.remove('error');
                    resultElement.classList.add('success');
                    validStates.userName = true;
                }
                checkFormValid();
            }

            function validNameCheck(name) {
                let namePattern = /^[가-힣a-zA-Z]{2,10}$/;
                return namePattern.test(name);
            }

            // 전화번호 형식 정규식 체크
            function validTel(telInput, resultElement) {
                const tel = telInput.value.trim();
                if (tel.length === 0) {
                    resultElement.textContent = '전화번호를 입력해주세요.';
                    resultElement.classList.remove('success');
                    resultElement.classList.add('error');
                    telInput.focus();
                    validStates.userTel = false;
                } else if (!validTelCheck(tel)) {
                    resultElement.textContent = '번호를 올바르게 입력해주세요.';
                    resultElement.classList.remove('success');
                    resultElement.classList.add('error');
                    telInput.focus();
                    validStates.userTel = false;
                } else {
                    // 전화번호 형식이 유효한 경우, 서버에 중복 검사 요청
                    checkTelDuplication(telInput, resultElement);
                }
                checkFormValid();
            }

            // 서버에 전화번호 중복 검사 요청
            function checkTelDuplication(telInput, resultElement) {
                const userTel = telInput.value.trim();
                fetch('/user/userTelCheck?userTel=' + encodeURIComponent(userTel), {
                    method: 'GET',
                    credentials: 'include',
                    body: JSON.stringify({userTel: userTel})
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('네트워크 응답이 정상이 아닙니다.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.isDuplicate) {
                            resultElement.textContent = '이미 사용 중인 전화번호입니다.';
                            resultElement.classList.add('error');
                            resultElement.classList.remove('success');
                            validStates.userTel = false;
                        } else {
                            resultElement.textContent = '올바른 전화번호 형식입니다.';
                            resultElement.classList.remove('error');
                            resultElement.classList.add('success');
                            validStates.userTel = true;
                        }
                        checkFormValid();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        resultElement.textContent = '서버 에러로 중복 체크를 할 수 없습니다.';
                        resultElement.classList.add('error');
                        resultElement.classList.remove('success');
                        validStates.userTel = false;
                        checkFormValid();
                    });
            }



            function validTelCheck(tel) {
                let telPattern = /^01(0|1|[6-9])[0-9]{3,4}[0-9]{4}$/;
                return telPattern.test(tel);
            }

            const csrfTokenElement = document.querySelector('input[name="_csrf"]');
            const csrfToken = csrfTokenElement ? csrfTokenElement.value : null;
            console.log(csrfToken);

            // 회원가입 폼 데이터 전송
            document.getElementById('userRegister').addEventListener('submit', function (e) {
                e.preventDefault();
                if (!submitButton.disabled) {
                    const userData = {
                        userEmail: userEmail.value,
                        userPassword: userPassword.value,
                        userName: userName.value,
                        userTel: userTel.value,
                        userAddr: userAddr.value,
                        _csrf: document.querySelector('[name="_csrf"]').value
                    };
                    fetch('/auth/user/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        credentials: 'include',
                        body: JSON.stringify(userData)
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.resultCode === 201) {
                                alert(data.resultMsg);
                                window.location.href = '/user/login';
                            } else {
                                throw new Error('잠시 후 다시 시도해 주세요.');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert(error.message);
                        });
                }
            });
        });
    </script>
</head>
<body>
<h3 style="text-align: center;">사용자 회원가입</h3>
<div class="join-form">
    <div class="content">
        <form id="userRegister" method="POST">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <h3>이메일</h3>
            <label for="userEmail">
                <input type="text" name="userEmail" id="userEmail" class="text-field"
                       placeholder="이메일 ex) abc1234@naver.com">
            </label><br/>
            <span class="email-result"></span>

            <h3>비밀번호</h3>
            <label for="userPassword">
                <input type="password" name="userPassword" id="userPassword" class="text-field"
                       placeholder="비밀번호">
            </label><br/>
            <span class="password-result"></span>

            <h3>비밀번호 확인</h3>
            <label for="userRePassword">
                <input type="password" id="userRePassword" class="text-field" placeholder="비밀번호 확인">
            </label><br/>
            <span class="rePassword-result"></span>

            <h3>이름</h3>
            <label for="userName">
                <input type="text" name="userName" id="userName" class="text-field" placeholder="이름">
            </label><br/>
            <span class="name-result"></span>

            <h3>전화번호</h3>
            <label for="userTel">
                <input type="tel" name="userTel" id="userTel" class="text-field"
                       placeholder="-를 제외한 숫자만 입력 바랍니다.">
            </label><br/>
            <span class="tel-result"></span>

            <h3>주소</h3>
            <label for="user_postcode">
                <input type="text" id="user_postcode" class="text-field-postcode" placeholder="우편번호">
            </label>

            <input type="button" onclick="user_execDaumPostcode()" class="button-postcode" value="우편번호 찾기"><br>

            <label for="user_roadAddress">
                <input type="text" id="user_roadAddress" class="text-field-postcode" placeholder="도로명주소">
            </label>

            <label for="user_jibunAddress">
                <input type="text" id="user_jibunAddress" class="text-field-postcode" placeholder="지번주소">
            </label>

            <span id="guide" style="color:#999;display:none"></span>
            <label for="user_detailAddress">
                <input type="text" id="user_detailAddress" class="text-field-postcode" placeholder="상세주소">
            </label>

            <label for="user_extraAddress">
                <input type="text" id="user_extraAddress" class="text-field-postcode" placeholder="참고항목">
            </label>

            <br/>

            <h3>입력한 주소</h3>
            <label for="userAddress">
                <input type="text" name="userAddress" id="userAddress" class="text-field"
                       placeholder="입력한 주소" readonly>
            </label>

            <button type="submit" class="submit-btn" id="btnUserJoin" disabled>가입하기</button>
            <button type="button" class="reset-btn" id="btnReset">돌아가기</button>
        </form>
    </div>
</div>
</body>
</html>